name: Test PR

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

env:
  REGISTRY: docker.io
  IMAGE_NAME: kugieapp/chalkboard

jobs:
  test:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_USER: postgres
          POSTGRES_DB: chalkboard_test
          POSTGRES_INITDB_ARGS: "--auth-host=scram-sha-256 --auth-local=scram-sha-256"
        options: >-
          --health-cmd "pg_isready -U postgres"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    env:
      DATABASE_URL: "postgresql://postgres:postgres@localhost:5432/chalkboard_test"
      NEXTAUTH_SECRET: "test-secret-key-for-github-actions-only"
      NEXTAUTH_URL: "http://localhost:3000"
      DEPLOYMENT_MODE: "test"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run database migrations
        run: |
          bun run db:generate
          bun run db:setup-test

      - name: Run tests
        run: bun run test:coverage --passWithNoTests

      - name: Upload test coverage
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage/lcov.info
          fail_ci_if_error: false
          verbose: true

      - name: Lint check
        run: bun run lint || echo "Linting skipped"

  build:
    needs: test
    if: always()
    runs-on: ubuntu-latest
    env:
      DATABASE_URL: "postgresql://user:password@localhost:5432/chalkboard_build"
      NEXTAUTH_SECRET: "build-time-secret-key-for-github-actions-only"
      NEXTAUTH_URL: "http://localhost:3000"
      DEPLOYMENT_MODE: "auto"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build check
        run: bun run build

  build-tauri-check:
    needs: test
    runs-on: macos-latest
    env:
      DEPLOYMENT_MODE: desktop
      NEXTAUTH_SECRET: "build-time-secret-key-for-github-actions-only"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build Tauri app (macOS aarch64)
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          args: --target aarch64-apple-darwin
          uploadWorkflowArtifacts: true

  build-tauri:
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: ubuntu-22.04
            rust-targets: ''
          - platform: windows-latest
            rust-targets: ''
    runs-on: ${{ matrix.platform }}
    env:
      DEPLOYMENT_MODE: desktop
      NEXTAUTH_SECRET: "build-time-secret-key-for-github-actions-only"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Linux dependencies
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.rust-targets }}

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          args: ${{ matrix.rust-targets && format('--target {0}', matrix.rust-targets) || '' }}
          uploadWorkflowArtifacts: true

  build-docker:
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image (no push)
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64
          push: false
          tags: ${{ env.IMAGE_NAME }}:test
          build-args: |
            DATABASE_URL=postgresql://user:password@localhost:5432/chalkboard_build
            NEXTAUTH_SECRET=build-time-secret-key-for-github-actions-only
            NEXTAUTH_URL=http://localhost:3000
            DEFAULT_EMAIL=admin@example.com
            DEFAULT_PASSWORD=admin123
            DEPLOYMENT_MODE=auto
            USE_SERVERLESS_DB=false
            DB_POOLING=true
          cache-from: type=gha
          cache-to: type=gha,mode=max

  summary:
    needs: [test, build, build-tauri-check, build-tauri, build-docker]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check test results
        run: |
          if [[ "${{ needs.test.result }}" != "success" ]]; then
            echo "‚ö†Ô∏è Tests failed - but builds were allowed to continue"
            echo "::warning::Unit tests failed. Please review and fix test failures."
          else
            echo "‚úÖ Tests passed"
          fi

      - name: Check build results
        run: |
          if [[ "${{ needs.build.result }}" != "success" ]]; then
            echo "‚ùå Standard build failed"
            exit 1
          else
            echo "‚úÖ Standard build passed"
          fi

      - name: Check Tauri build results
        run: |
          if [[ "${{ needs.build-tauri-check.result }}" != "success" ]]; then
            echo "‚ùå Tauri macOS aarch64 build failed"
            exit 1
          else
            echo "‚úÖ Tauri macOS aarch64 build passed"
          fi
          if [[ "${{ needs.build-tauri.result }}" == "success" ]]; then
            echo "‚úÖ Tauri platform builds passed"
          elif [[ "${{ needs.build-tauri.result }}" == "skipped" ]]; then
            echo "‚ÑπÔ∏è Tauri platform builds skipped (main-only)"
          else
            echo "‚ùå Tauri platform builds failed"
            exit 1
          fi

      - name: Check Docker build results
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          if [[ "${{ needs.build-docker.result }}" != "success" ]]; then
            echo "‚ùå Docker build failed"
            exit 1
          else
            echo "‚úÖ Docker build passed"
          fi

      - name: All checks completed
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "üéâ PR checks completed!"
            if [[ "${{ needs.test.result }}" == "success" ]]; then
              echo "‚úÖ Unit tests passed"
            else
              echo "‚ö†Ô∏è Unit tests failed"
            fi
            echo "‚úÖ Standard build succeeded"
            echo "‚úÖ Tauri macOS aarch64 build checked"
            echo "‚ÑπÔ∏è Other Tauri and Docker builds skipped for PR"
          else
            echo "üéâ All builds completed!"
            if [[ "${{ needs.test.result }}" == "success" ]]; then
              echo "‚úÖ Unit tests passed"
            else
              echo "‚ö†Ô∏è Unit tests failed (but builds continued)"
            fi
            echo "‚úÖ Standard build succeeded"
            echo "‚úÖ Tauri desktop builds succeeded"
            echo "‚úÖ Docker build succeeded"
          fi