version: '3.8'

services:
  # Default service (auto mode)
  chalkboard:
    platform: linux/amd64
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - DATABASE_URL=${DATABASE_URL:-postgresql://username:password@host:5432/database}
        - NEXTAUTH_SECRET=${NEXTAUTH_SECRET:-your-nextauth-secret}
        - NEXTAUTH_URL=${NEXTAUTH_URL:-http://localhost:3000}
        - DEFAULT_EMAIL=${DEFAULT_EMAIL:-admin@example.com}
        - DEFAULT_PASSWORD=${DEFAULT_PASSWORD:-admin123}
        - DEPLOYMENT_MODE=${DEPLOYMENT_MODE:-auto}
        - USE_SERVERLESS_DB=${USE_SERVERLESS_DB:-false}
        - DB_POOLING=${DB_POOLING:-true}
    ports:
      - "3000:3000"
    image: kugieapp/chalkboard:latest
    environment:
      - DATABASE_URL=${DATABASE_URL:-postgresql://username:password@host:5432/database}
      - NEXTAUTH_SECRET=${NEXTAUTH_SECRET:-your-nextauth-secret}
      - NEXTAUTH_URL=${NEXTAUTH_URL:-http://localhost:3000}
      - DEFAULT_EMAIL=${DEFAULT_EMAIL:-admin@example.com}
      - DEFAULT_PASSWORD=${DEFAULT_PASSWORD:-admin123}
      - DEPLOYMENT_MODE=${DEPLOYMENT_MODE:-auto}
      - USE_SERVERLESS_DB=${USE_SERVERLESS_DB:-false}
      - DB_POOLING=${DB_POOLING:-true}
    restart: unless-stopped
    profiles:
      - default
      - auto

  # Edge-optimized service
  chalkboard-edge:
    extends: chalkboard
    build:
      args:
        - DEPLOYMENT_MODE=edge
        - USE_SERVERLESS_DB=true
        - DB_POOLING=false
        - NEXT_RUNTIME=edge
    image: kugieapp/chalkboard:edge
    environment:
      - DEPLOYMENT_MODE=edge
      - USE_SERVERLESS_DB=true
      - DB_POOLING=false
      - NEXT_RUNTIME=edge
    profiles:
      - edge

  # Node.js optimized service
  chalkboard-node:
    extends: chalkboard
    build:
      args:
        - DEPLOYMENT_MODE=node
        - USE_SERVERLESS_DB=false
        - DB_POOLING=true
    image: kugieapp/chalkboard:node
    environment:
      - DEPLOYMENT_MODE=node
      - USE_SERVERLESS_DB=false
      - DB_POOLING=true
    profiles:
      - node